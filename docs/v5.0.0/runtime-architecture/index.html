<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-v5.0.0 plugin-docs plugin-id-default docs-doc-id-runtime-architecture">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Runtime Architecture | Relay</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://relay.dev/img/relay.png"><meta data-rh="true" name="twitter:image" content="https://relay.dev/img/relay.png"><meta data-rh="true" property="og:url" content="https://relay.dev/docs/v5.0.0/runtime-architecture/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v5.0.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v5.0.0"><meta data-rh="true" name="docsearch:version" content="v5.0.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v5.0.0"><meta data-rh="true" property="og:title" content="Runtime Architecture | Relay"><meta data-rh="true" name="description" content="The Relay runtime is a full-featured GraphQL client that is designed for high performance even on low-end mobile devices and is capable of scaling to large, complex apps. The runtime API is not intended to be used directly in product code, but rather to provide a foundation for building higher-level product APIs such as React/Relay. This foundation includes:"><meta data-rh="true" property="og:description" content="The Relay runtime is a full-featured GraphQL client that is designed for high performance even on low-end mobile devices and is capable of scaling to large, complex apps. The runtime API is not intended to be used directly in product code, but rather to provide a foundation for building higher-level product APIs such as React/Relay. This foundation includes:"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://relay.dev/docs/v5.0.0/runtime-architecture/"><link data-rh="true" rel="alternate" href="https://relay.dev/docs/v5.0.0/runtime-architecture/" hreflang="en"><link data-rh="true" rel="alternate" href="https://relay.dev/docs/v5.0.0/runtime-architecture/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Relay RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Relay Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-DCSC7FDGL5","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DCSC7FDGL5"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DCSC7FDGL5",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="Relay" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.21fd5f5d.css">
<link rel="preload" href="/assets/js/runtime~main.cc5d5b6e.js" as="script">
<link rel="preload" href="/assets/js/main.ea28af0c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>

<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div role="region" aria-label="theme.common.skipToMainContent"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Relay</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link" href="/help/">Help</a><a href="https://github.com/facebook/relay" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/v5.0.0/">v5.0.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/">Next ğŸš§</a></li><li><a class="dropdown__link" href="/docs/">v15.0.0</a></li><li><a class="dropdown__link" href="/docs/v14.0.0/">v14.0.0</a></li><li><a class="dropdown__link" href="/docs/v13.0.0/">v13.0.0</a></li><li><a class="dropdown__link" href="/docs/v12.0.0/">v12.0.0</a></li><li><a class="dropdown__link" href="/docs/v11.0.0/">v11.0.0</a></li><li><a class="dropdown__link" href="/docs/v10.1.3/runtime-architecture/">v10.1.3</a></li><li><a class="dropdown__link" href="/docs/v10.1.2/runtime-architecture/">v10.1.2</a></li><li><a class="dropdown__link" href="/docs/v10.1.1/runtime-architecture/">v10.1.1</a></li><li><a class="dropdown__link" href="/docs/v10.1.0/runtime-architecture/">v10.1.0</a></li><li><a class="dropdown__link" href="/docs/v10.0.1/runtime-architecture/">v10.0.1</a></li><li><a class="dropdown__link" href="/docs/v10.0.0/runtime-architecture/">v10.0.0</a></li><li><a class="dropdown__link" href="/docs/v9.1.0/runtime-architecture/">v9.1.0</a></li><li><a class="dropdown__link" href="/docs/v9.0.0/runtime-architecture/">v9.0.0</a></li><li><a class="dropdown__link" href="/docs/v8.0.0/runtime-architecture/">v8.0.0</a></li><li><a class="dropdown__link" href="/docs/v7.1.0/runtime-architecture/">v7.1.0</a></li><li><a class="dropdown__link" href="/docs/v7.0.0/runtime-architecture/">v7.0.0</a></li><li><a class="dropdown__link" href="/docs/v6.0.0/runtime-architecture/">v6.0.0</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/v5.0.0/runtime-architecture/">v5.0.0</a></li><li><a class="dropdown__link" href="/docs/v4.0.0/runtime-architecture/">v4.0.0</a></li><li><a class="dropdown__link" href="/docs/v3.0.0/runtime-architecture/">v3.0.0</a></li><li><a class="dropdown__link" href="/docs/v2.0.0/runtime-architecture/">v2.0.0</a></li><li><a class="dropdown__link" href="/docs/v1.7.0/runtime-architecture/">v1.7.0</a></li><li><a class="dropdown__link" href="/docs/v1.6.2/runtime-architecture/">v1.6.2</a></li><li><a class="dropdown__link" href="/docs/v1.6.1/runtime-architecture/">v1.6.1</a></li><li><a class="dropdown__link" href="/docs/v1.6.0/runtime-architecture/">v1.6.0</a></li><li><a class="dropdown__link" href="/docs/v1.5.0/runtime-architecture/">v1.5.0</a></li><li><a class="dropdown__link" href="/docs/v1.4.1/runtime-architecture/">v1.4.1</a></li><li><a class="dropdown__link" href="/versions/">All versions</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/v5.0.0/">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/v5.0.0/graphql-in-relay/">API Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/v5.0.0/routing/">Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/v5.0.0/thinking-in-graphql/">Principles &amp; Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v5.0.0/thinking-in-graphql/">Thinking in GraphQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v5.0.0/thinking-in-relay/">Thinking In Relay</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v5.0.0/architecture-overview/">Architecture Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v5.0.0/compiler-architecture/">Compiler Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/v5.0.0/runtime-architecture/">Runtime Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v5.0.0/videos/">Videos</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/v5.0.0/community-learning-resources/">Community</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Relay<!-- --> <b>v5.0.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/">latest version</a></b> (<!-- -->v15.0.0<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><span class="theme-doc-version-badge badge badge--secondary">Version: v5.0.0</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Runtime Architecture</h1></header><p>The Relay runtime is a full-featured GraphQL client that is designed for high performance even on low-end mobile devices and is capable of scaling to large, complex apps. The runtime API is not intended to be used directly in product code, but rather to provide a foundation for building higher-level product APIs such as React/Relay. This foundation includes:</p><ul><li>A normalized, in-memory object graph/cache.</li><li>An optimized &quot;write&quot; operation for updating the cache with the results of queries/mutations/subscriptions.</li><li>A mechanism for reading data from the cache and subscribing for updates when these results change due to a mutation, subscription update, etc.</li><li>Garbage collection to evict entries from the cache when they can no longer be referenced by any view.</li><li>A generic mechanism for intercepting data prior to publishing it to the cache and either synthesizing new data or merging new and existing data together (which among other things enables the creation of a variety of pagination schemes).</li><li>Mutations with optimistic updates and the ability to update the cache with arbitrary logic.</li><li>Support for live queries where supported by the network/server.</li><li>Core primitives to enable subscriptions.</li><li>Core primitives for building offline/persisted caching.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="comparison-to-classic-relay">Comparison to Classic Relay<a class="hash-link" href="#comparison-to-classic-relay" title="Direct link to heading">â€‹</a></h2><p>For users of classic Relay, note that the runtime makes as few assumptions as possible about GraphQL. Compared to earlier versions of Relay there is no concept of routes, there are no limitations on mutation input arguments or side-effects, arbitrary root fields just work, etc. At present, the main restriction from classic Relay that remains is the use of the <code>Node</code> interface and <code>id</code> field for object identification. However there is no fundamental reason that this restriction can&#x27;t be relaxed (there is a single place in the codebase where object identity is determined), and we welcome feedback from the community about ways to support customizable object identity without negatively impacting performance.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-types">Data Types<a class="hash-link" href="#data-types" title="Direct link to heading">â€‹</a></h2><p> (subsequent sections explain how these types are used in practice):</p><ul><li><code>DataID</code> (type): A globally unique or client-generated identifier for a record, stored as a string.</li><li><code>Record</code> (type): A representation of a distinct data entity with an identity, type, and fields. Note that the actual runtime representation is opaque to the system: all accesses to <code>Record</code> objects (including record creation) is mediated through the <code>RelayModernRecord</code> module. This allows the representation itself to be changed in a single place (e.g. to use <code>Map</code>s or a custom class). It is important that other code does not assume that <code>Record</code>s will always be plain objects.</li><li><code>RecordSource</code> (type): A collection of records keyed by their data ID, used both to represent the cache and updates to it. For example the store&#x27;s record cache is a <code>RecordSource</code> and the results of queries/mutations/subscriptions are normalized into <code>RecordSource</code>s that are published to a store. Sources also define methods for asynchronously loading records in order to (eventually) support offline use-cases. Currently the only implementation of this interface is <code>RelayInMemoryRecordSource</code>; future implementations may add support for loading records from disk.</li><li><code>Store</code> (type): The source of truth for an instance of <code>RelayRuntime</code>, holding the canonical set of records in the form of a <code>RecordSource</code> (though this is not required). Currently the only implementation is <code>RelayModernStore</code>.</li><li><code>Network</code> (type): Provides methods for fetching query data from and executing mutations against an external data source.</li><li><code>Environment</code> (type): Represents an encapsulated environment combining a <code>Store</code> and <code>Network</code>, providing a high-level API for interacting with both. This is the main public API of <code>RelayRuntime</code>.</li></ul><p>Types for working with queries and their results include:</p><ul><li><code>Selector</code> (type): A selector defines the starting point for a traversal into the graph for the purposes of targeting a subgraph, combining a GraphQL fragment, variables, and the Data ID for the root object from which traversal should progress. Intuitively, this &quot;selects&quot; a portion of the object graph.</li><li><code>Snapshot</code> (type): The (immutable) results of executing a <code>Selector</code> at a given point in time. This includes the selector itself, the results of executing it, and a list of the Data IDs from which data was retrieved (useful in determining when these results might change).</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-model">Data Model<a class="hash-link" href="#data-model" title="Direct link to heading">â€‹</a></h2><p>Relay Runtime is designed for use with GraphQL schemas that describe <strong>object graphs</strong> in which objects have a type, an identity, and a set of fields with values. Objects may reference each other, which is represented by fields whose values are one or more other objects in the graph <!-- -->[1]<!-- -->. To distinguish from JavaScript <code>Object</code>s, these units of data are referred to as <code>Record</code>s. Relay represents both its internal cache as well as query/mutation/etc results as a mapping of <strong>data ID</strong>s to <strong>records</strong>. The data ID is the unique (with respect to the cache) identifier for a record - it may be the value of an actual <code>id</code> field or based on the path to the record from the nearest object with an <code>id</code> (such path-based ids are called <strong>client ids</strong>). Each <code>Record</code> stores its data ID, type, and any fields that have been fetched. Multiple records are stored together as a <code>RecordSource</code>: a mapping of data IDs to <code>Record</code> instances.</p><p>For example, a user and their address might be represented as follows:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:black;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:black"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:black"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// GraphQL Fragment</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">fragment on </span><span class="token maybe-class-name">User</span><span class="token plain"> </span><span class="token punctuation" style="color:#b58a5e">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">  id</span><br></span><span class="token-line" style="color:black"><span class="token plain">  name</span><br></span><span class="token-line" style="color:black"><span class="token plain">  address </span><span class="token punctuation" style="color:#b58a5e">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    city</span><br></span><span class="token-line" style="color:black"><span class="token plain">  </span><span class="token punctuation" style="color:#b58a5e">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain"></span><span class="token punctuation" style="color:#b58a5e">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:black"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Response</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain"></span><span class="token punctuation" style="color:#b58a5e">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">  </span><span class="token literal-property property" style="color:black">id</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token string" style="color:#65822b">&#x27;842472&#x27;</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">  </span><span class="token literal-property property" style="color:black">name</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token string" style="color:#65822b">&#x27;Joe&#x27;</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">  </span><span class="token literal-property property" style="color:black">address</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#b58a5e">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    </span><span class="token literal-property property" style="color:black">city</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token string" style="color:#65822b">&#x27;Seattle&#x27;</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">  </span><span class="token punctuation" style="color:#b58a5e">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain"></span><span class="token punctuation" style="color:#b58a5e">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:black"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Normalized Representation</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain"></span><span class="token maybe-class-name">RecordSource</span><span class="token plain"> </span><span class="token punctuation" style="color:#b58a5e">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">  </span><span class="token string-property property" style="color:black">&#x27;842472&#x27;</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token maybe-class-name">Record</span><span class="token plain"> </span><span class="token punctuation" style="color:#b58a5e">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    </span><span class="token literal-property property" style="color:black">__id</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token string" style="color:#65822b">&#x27;842472&#x27;</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    </span><span class="token literal-property property" style="color:black">__typename</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token string" style="color:#65822b">&#x27;User&#x27;</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// the type is known statically from the fragment</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    </span><span class="token literal-property property" style="color:black">id</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token string" style="color:#65822b">&#x27;842472&#x27;</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    </span><span class="token literal-property property" style="color:black">name</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token string" style="color:#65822b">&#x27;Joe&#x27;</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    </span><span class="token literal-property property" style="color:black">address</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#b58a5e">{</span><span class="token literal-property property" style="color:black">__ref</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token string" style="color:#65822b">&#x27;client:842472:address&#x27;</span><span class="token punctuation" style="color:#b58a5e">}</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// link to another record</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">  </span><span class="token punctuation" style="color:#b58a5e">}</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">  </span><span class="token string-property property" style="color:black">&#x27;client:842472:address&#x27;</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token maybe-class-name">Record</span><span class="token plain"> </span><span class="token punctuation" style="color:#b58a5e">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// A client ID, derived from the path from parent &amp; parent&#x27;s ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    </span><span class="token literal-property property" style="color:black">__id</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token string" style="color:#65822b">&#x27;client:842472:address&#x27;</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    </span><span class="token literal-property property" style="color:black">__typename</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token string" style="color:#65822b">&#x27;Address&#x27;</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    </span><span class="token literal-property property" style="color:black">city</span><span class="token operator" style="color:#b58a5e">:</span><span class="token plain"> </span><span class="token string" style="color:#65822b">&#x27;Seattle&#x27;</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">  </span><span class="token punctuation" style="color:#b58a5e">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain"></span><span class="token punctuation" style="color:#b58a5e">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>[1]<!-- --> Note that GraphQL itself does not impose this constraint, and Relay Runtime may also be used for schemas that do not conform to it. For example, both systems can be used to query a single denormalized table. However, many of the features that Relay Runtime provides, such as caching and normalization, work best when the data is represented as a normalized graph with stable identities for discrete pieces of information.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="store-operations">Store Operations<a class="hash-link" href="#store-operations" title="Direct link to heading">â€‹</a></h3><p>The <code>Store</code> is the source of truth for application data and provides the following core operations.</p><ul><li><p><code>lookup(selector: Selector): Snapshot</code>: Reads the results of a selector from the store, returning the value given the data currently in the store.</p></li><li><p><code>subscribe(snapshot: Snapshot, callback: (snapshot: Snapshot) =&gt; void): Disposable</code>: Subscribe to changes to the results of a selector. The callback is called when data has been published to the store that would cause the results of the snapshot&#x27;s selector to change.</p></li><li><p><code>publish(source: RecordSource): void</code>: Update the store with new information. All updates to the store are expressed in this form, including the results of queries/mutation/subscriptions as well as optimistic mutation updates. All of those operations internally create a new <code>RecordSource</code> instance and ultimately publish it to the store. Note that <code>publish()</code> does <em>not</em> immediately update any <code>subscribe()</code>-ers. Internally, the store compares the new <code>RecordSource</code> with its internal source, updating it as necessary:</p><ul><li>Records that exist only in the published source are added to the store.</li><li>Records that exist in both are merged into a new record (inputs unchanged), with the result added to the store.</li><li>Records that are null in the published source are deleted (set to null) in the store.</li><li>Records with a special sentinel value are removed from the store. This supports un-publishing optimistically created records.</li></ul></li><li><p><code>notify(): void</code>: Calls any <code>subscribe()</code>-ers whose results have changed due to intervening <code>publish()</code>-es. Separating <code>publish()</code> and <code>notify()</code> allows for multiple payloads to be published before performing any downstream update logic (such as rendering).</p></li><li><p><code>retain(selector: Selector): Disposable</code>: Ensure that all the records necessary to fulfill the given selector are retained in-memory. The records will not be eligible for garbage collection until the returned reference is disposed.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-data-flow-fetching-query-data">Example Data Flow: Fetching Query Data<a class="hash-link" href="#example-data-flow-fetching-query-data" title="Direct link to heading">â€‹</a></h3><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:black;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:black"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:black"><span class="token plain">               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â”‚         </span><span class="token maybe-class-name">Query</span><span class="token plain">         â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â–¼</span><br></span><span class="token-line" style="color:black"><span class="token plain">                                             â”Œ â”€ â”€ â”€ â”</span><br></span><span class="token-line" style="color:black"><span class="token plain">                         fetch â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ </span><span class="token maybe-class-name">Server</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">                                             â”” â”€ â”€ â”€ â”˜</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”</span><br></span><span class="token-line" style="color:black"><span class="token plain">                     â–¼             â–¼</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â”‚  </span><span class="token maybe-class-name">Query</span><span class="token plain">   â”‚  â”‚ </span><span class="token maybe-class-name">Response</span><span class="token plain"> â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></span><span class="token-line" style="color:black"><span class="token plain">                     â”‚             â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â–¼</span><br></span><span class="token-line" style="color:black"><span class="token plain">                       normalize</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â–¼</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â”‚     </span><span class="token maybe-class-name">RecordSource</span><span class="token plain">      â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â”‚                       â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â”‚â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â”‚â”‚Recordâ”‚â”‚Recordâ”‚â”‚ </span><span class="token spread operator" style="color:#b58a5e">...</span><span class="token plain"> â”‚â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â”‚â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></span><span class="token-line" style="color:black"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>The query is fetched from the network.</li><li>The query and response are traversed together, extracting the results into <code>Record</code> objects which are added to a fresh <code>RecordSource</code>.</li></ol><p>This fresh <code>RecordSource</code> would then be published to the store:</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:black;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:black"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:black"><span class="token plain">                        publish</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â–¼</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚           </span><span class="token maybe-class-name">Store</span><span class="token plain">           â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚     </span><span class="token maybe-class-name">RecordSource</span><span class="token plain">      â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚                       â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚â”Œ â”€ â”€ â”€ â”Œ â”€ â”€ â”€ â”Œ â”€ â”€ â”â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚ </span><span class="token maybe-class-name">Recordâ”‚</span><span class="token plain"> </span><span class="token maybe-class-name">Recordâ”‚</span><span class="token plain">  </span><span class="token spread operator" style="color:#b58a5e">...</span><span class="token plain">  â”‚ â”‚  </span><span class="token operator" style="color:#b58a5e">&lt;</span><span class="token operator" style="color:#b58a5e">--</span><span class="token operator" style="color:#b58a5e">-</span><span class="token plain"> records are updated</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚â”” â”€ â”€ â”€ â”” â”€ â”€ â”€ â”” â”€ â”€ â”˜â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚     </span><span class="token maybe-class-name">Subscriptions</span><span class="token plain">     â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚                       â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚â”‚ </span><span class="token maybe-class-name">Sub</span><span class="token punctuation" style="color:#b58a5e">.</span><span class="token plain"> </span><span class="token property-access">â”‚â”‚</span><span class="token plain"> </span><span class="token maybe-class-name">Sub</span><span class="token punctuation" style="color:#b58a5e">.</span><span class="token plain"> </span><span class="token property-access">â”‚â”‚</span><span class="token plain"> </span><span class="token spread operator" style="color:#b58a5e">...</span><span class="token plain"> â”‚â”‚ â”‚ </span><span class="token operator" style="color:#b58a5e">&lt;</span><span class="token operator" style="color:#b58a5e">--</span><span class="token operator" style="color:#b58a5e">-</span><span class="token plain"> subscriptions </span><span class="token keyword control-flow" style="color:#00009f">do</span><span class="token plain"> not fire yet</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></span><span class="token-line" style="color:black"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Publishing the results updates the store but does <em>not</em> immediately notify any subscribers. This is accomplished by calling <code>notify()</code>...</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:black;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:black"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:black"><span class="token plain">                        notify</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â–¼</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚           </span><span class="token maybe-class-name">Store</span><span class="token plain">           â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚     </span><span class="token maybe-class-name">RecordSource</span><span class="token plain">      â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚                       â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚â”‚Recordâ”‚â”‚Recordâ”‚â”‚ </span><span class="token spread operator" style="color:#b58a5e">...</span><span class="token plain"> â”‚â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚     </span><span class="token maybe-class-name">Subscriptions</span><span class="token plain">     â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚                       â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚â”Œ â”€ â”€ â”€ â”Œ â”€ â”€ â”€ â”Œ â”€ â”€ â”â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚  </span><span class="token maybe-class-name">Sub</span><span class="token punctuation" style="color:#b58a5e">.</span><span class="token plain"> </span><span class="token property-access">â”‚</span><span class="token plain">  </span><span class="token maybe-class-name">Sub</span><span class="token punctuation" style="color:#b58a5e">.</span><span class="token plain"> </span><span class="token property-access">â”‚</span><span class="token plain">  </span><span class="token spread operator" style="color:#b58a5e">...</span><span class="token plain">  â”‚ â”‚ </span><span class="token operator" style="color:#b58a5e">&lt;</span><span class="token operator" style="color:#b58a5e">--</span><span class="token operator" style="color:#b58a5e">-</span><span class="token plain"> affected subscriptions fire</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â”‚â”” â”€â”‚â”€ â”€ â”” â”€â”‚â”€ â”€ â”” â”€â”‚â”€ â”˜â”‚ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â”‚ â””â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”˜ â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">             â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜</span><br></span><span class="token-line" style="color:black"><span class="token plain">                   â”‚       â”‚       â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                   â–¼       â”‚       â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">               callback    â”‚       â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                           â–¼       â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                       callback    â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                                   â–¼</span><br></span><span class="token-line" style="color:black"><span class="token plain">                               callback</span><br></span><span class="token-line" style="color:black"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>...which calls the callbacks for any <code>subscribe()</code>-ers whose results have changed. Each subscription is checked as follows:</p><ol><li>First, the list of data IDs that have changed since the last <code>notify()</code> is compared against data IDs listed in the subscription&#x27;s latest <code>Snapshot</code>. If there is no overlap, the subscription&#x27;s results cannot possibly have changed (if you imagine the graph visually, there is no overlap between the part of the graph that changed and the part that is selected). In this case the subscription is ignored, otherwise processing continues.</li><li>Second, any subscriptions that do have overlapping data IDs are re-read, and the new/previous results are compared. If the result has not changed, the subscription is ignored (this can occur if a field of a record changed that is not relevant to the subscription&#x27;s selector), otherwise processing continues.</li><li>Finally, subscriptions whose data actually changed are notified via their callback.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-data-flow-reading-and-observing-the-store">Example Data Flow: Reading and Observing the Store<a class="hash-link" href="#example-data-flow-reading-and-observing-the-store" title="Direct link to heading">â€‹</a></h3><p>Products access the store primarily via <code>lookup()</code> and <code>subscribe()</code>. Lookup reads the initial results of a fragment, and subscribe observes that result for any changes. Note that the output of <code>lookup()</code> - a <code>Snapshot</code> - is the input to <code>subscribe()</code>. This is important because the snapshot contains important information that can be used to optimize the subscription - if <code>subscribe()</code> accepted only a <code>Selector</code>, it would have to re-read the results in order to know what to subscribe to, which is less efficient.</p><p>Therefore a typical data flow is as follows - note that this flow is managed automatically by higher-level APIs such as React/Relay. First a component will lookup the results of a selector against a record source (e.g. the store&#x27;s canonical source):</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:black;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:black"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:black"><span class="token plain">    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br></span><span class="token-line" style="color:black"><span class="token plain">    â”‚     </span><span class="token maybe-class-name">RecordSource</span><span class="token plain">      â”‚       â”‚              â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">    â”‚                       â”‚       â”‚              â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">    â”‚â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”â”‚       â”‚   </span><span class="token maybe-class-name">Selector</span><span class="token plain">   â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">    â”‚â”‚Recordâ”‚â”‚Recordâ”‚â”‚ </span><span class="token spread operator" style="color:#b58a5e">...</span><span class="token plain"> â”‚â”‚       â”‚              â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">    â”‚â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â”‚       â”‚              â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></span><span class="token-line" style="color:black"><span class="token plain">                â”‚                           â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                â”‚                           â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></span><span class="token-line" style="color:black"><span class="token plain">                               â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                               â”‚  lookup</span><br></span><span class="token-line" style="color:black"><span class="token plain">                               </span><span class="token function" style="color:black">â”‚</span><span class="token plain">  </span><span class="token punctuation" style="color:#b58a5e">(</span><span class="token plain">read</span><span class="token punctuation" style="color:#b58a5e">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:black"><span class="token plain">                               â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                               â–¼</span><br></span><span class="token-line" style="color:black"><span class="token plain">                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br></span><span class="token-line" style="color:black"><span class="token plain">                        â”‚             â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                        â”‚  </span><span class="token maybe-class-name">Snapshot</span><span class="token plain">   â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                        â”‚             â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></span><span class="token-line" style="color:black"><span class="token plain">                               â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                               â”‚  render</span><span class="token punctuation" style="color:#b58a5e">,</span><span class="token plain"> etc</span><br></span><span class="token-line" style="color:black"><span class="token plain">                               â”‚</span><br></span><span class="token-line" style="color:black"><span class="token plain">                               â–¼</span><br></span><span class="token-line" style="color:black"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, it will <code>subscribe()</code> using this snapshot in order to be notified of any changes - see the above diagram for <code>publish()</code> and <code>notify()</code>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/relay/tree/main/website/versioned_docs/version-v5.0.0/PrinciplesAndArchitecture-Runtime.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-08-31T04:30:29.000Z">Aug 31, 2023</time></b> by <b>Matt Mahoney</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/v5.0.0/compiler-architecture/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Compiler Architecture</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/v5.0.0/videos/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Videos</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#comparison-to-classic-relay" class="table-of-contents__link toc-highlight">Comparison to Classic Relay</a></li><li><a href="#data-types" class="table-of-contents__link toc-highlight">Data Types</a></li><li><a href="#data-model" class="table-of-contents__link toc-highlight">Data Model</a><ul><li><a href="#store-operations" class="table-of-contents__link toc-highlight">Store Operations</a></li><li><a href="#example-data-flow-fetching-query-data" class="table-of-contents__link toc-highlight">Example Data Flow: Fetching Query Data</a></li><li><a href="#example-data-flow-reading-and-observing-the-store" class="table-of-contents__link toc-highlight">Example Data Flow: Reading and Observing the Store</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/">Introduction</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" target="_self" href="/users/">User Showcase</a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/data-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Data Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/relay.svg" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/relay.svg" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></div><div class="footer__copyright">Copyright Â© 2023 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.cc5d5b6e.js"></script>
<script src="/assets/js/main.ea28af0c.js"></script>
</body>
</html>