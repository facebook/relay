<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Relay Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Relay Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-50","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-44373548-50"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-44373548-50",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="Relay" href="/opensearch.xml">
<script src="https://widget.surveymonkey.com/collect/website/js/tRaiETqnLgj758hTBazgdx2NnQ5W6bg3p3XoJtoYjHDMWZrhV7glVKgJgKV87xxk.js" defer="defer"></script><title data-react-helmet="true">Thinking in GraphQL | Relay</title><meta data-react-helmet="true" property="og:url" content="https://relay.dev/docs/v1.6.0/thinking-in-graphql"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="v1.6.0"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-v1.6.0"><meta data-react-helmet="true" property="og:title" content="Thinking in GraphQL | Relay"><meta data-react-helmet="true" name="description" content="GraphQL presents new ways for clients to fetch data by focusing on the needs of product developers and client applications. It provides a way for developers to specify the precise data needed for a view and enables a client to fetch that data in a single network request. Compared to traditional approaches such as REST, GraphQL helps applications to fetch data more efficiently (compared to resource-oriented REST approaches) and avoid duplication of server logic (which can occur with custom endpoints). Furthermore, GraphQL helps developers to decouple product code and server logic. For example, a product can fetch more or less information without requiring a change to every relevant server endpoint. It&#x27;s a great way to fetch data."><meta data-react-helmet="true" property="og:description" content="GraphQL presents new ways for clients to fetch data by focusing on the needs of product developers and client applications. It provides a way for developers to specify the precise data needed for a view and enables a client to fetch that data in a single network request. Compared to traditional approaches such as REST, GraphQL helps applications to fetch data more efficiently (compared to resource-oriented REST approaches) and avoid duplication of server logic (which can occur with custom endpoints). Furthermore, GraphQL helps developers to decouple product code and server logic. For example, a product can fetch more or less information without requiring a change to every relevant server endpoint. It&#x27;s a great way to fetch data."><meta data-react-helmet="true" property="og:image" content="https://relay.dev/img/relay.png"><meta data-react-helmet="true" name="twitter:image" content="https://relay.dev/img/relay.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://relay.dev/docs/v1.6.0/thinking-in-graphql"><link data-react-helmet="true" rel="alternate" href="https://relay.dev/docs/v1.6.0/thinking-in-graphql" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://relay.dev/docs/v1.6.0/thinking-in-graphql" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.a5398f49.css">
<link rel="preload" href="/assets/js/runtime~main.ef7b7e61.js" as="script">
<link rel="preload" href="/assets/js/main.a42acebb.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id="internaldocs-banner"></div><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><strong class="navbar__title">Relay</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link" href="/help">Help</a><a href="https://github.com/facebook/relay" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/docs/v1.6.0/">v1.6.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/">Next ðŸš§</a></li><li><a class="dropdown__link" href="/docs/">v11.0.0</a></li><li><a class="dropdown__link" href="/docs/v10.1.3/thinking-in-graphql">v10.1.3</a></li><li><a class="dropdown__link" href="/docs/v10.1.2/thinking-in-graphql">v10.1.2</a></li><li><a class="dropdown__link" href="/docs/v10.1.1/thinking-in-graphql">v10.1.1</a></li><li><a class="dropdown__link" href="/docs/v10.1.0/thinking-in-graphql">v10.1.0</a></li><li><a class="dropdown__link" href="/docs/v10.0.1/thinking-in-graphql">v10.0.1</a></li><li><a class="dropdown__link" href="/docs/v10.0.0/thinking-in-graphql">v10.0.0</a></li><li><a class="dropdown__link" href="/docs/v9.1.0/thinking-in-graphql">v9.1.0</a></li><li><a class="dropdown__link" href="/docs/v9.0.0/thinking-in-graphql">v9.0.0</a></li><li><a class="dropdown__link" href="/docs/v8.0.0/thinking-in-graphql">v8.0.0</a></li><li><a class="dropdown__link" href="/docs/v7.1.0/thinking-in-graphql">v7.1.0</a></li><li><a class="dropdown__link" href="/docs/v7.0.0/thinking-in-graphql">v7.0.0</a></li><li><a class="dropdown__link" href="/docs/v6.0.0/thinking-in-graphql">v6.0.0</a></li><li><a class="dropdown__link" href="/docs/v5.0.0/thinking-in-graphql">v5.0.0</a></li><li><a class="dropdown__link" href="/docs/v4.0.0/thinking-in-graphql">v4.0.0</a></li><li><a class="dropdown__link" href="/docs/v3.0.0/thinking-in-graphql">v3.0.0</a></li><li><a class="dropdown__link" href="/docs/v2.0.0/thinking-in-graphql">v2.0.0</a></li><li><a class="dropdown__link" href="/docs/v1.7.0/thinking-in-graphql">v1.7.0</a></li><li><a class="dropdown__link" href="/docs/v1.6.2/thinking-in-graphql">v1.6.2</a></li><li><a class="dropdown__link" href="/docs/v1.6.1/thinking-in-graphql">v1.6.1</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/v1.6.0/thinking-in-graphql">v1.6.0</a></li><li><a class="dropdown__link" href="/docs/v1.5.0/thinking-in-graphql">v1.5.0</a></li><li><a class="dropdown__link" href="/docs/v1.4.1/thinking-in-graphql">v1.4.1</a></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">Relay</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/blog/">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/help">Help</a></li><li class="menu__list-item"><a href="https://github.com/facebook/relay" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/">Next ðŸš§</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/">v11.0.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v10.1.3/thinking-in-graphql">v10.1.3</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v10.1.2/thinking-in-graphql">v10.1.2</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v10.1.1/thinking-in-graphql">v10.1.1</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v10.1.0/thinking-in-graphql">v10.1.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v10.0.1/thinking-in-graphql">v10.0.1</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v10.0.0/thinking-in-graphql">v10.0.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v9.1.0/thinking-in-graphql">v9.1.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v9.0.0/thinking-in-graphql">v9.0.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v8.0.0/thinking-in-graphql">v8.0.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v7.1.0/thinking-in-graphql">v7.1.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v7.0.0/thinking-in-graphql">v7.0.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v6.0.0/thinking-in-graphql">v6.0.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v5.0.0/thinking-in-graphql">v5.0.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v4.0.0/thinking-in-graphql">v4.0.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v3.0.0/thinking-in-graphql">v3.0.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v2.0.0/thinking-in-graphql">v2.0.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v1.7.0/thinking-in-graphql">v1.7.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v1.6.2/thinking-in-graphql">v1.6.2</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v1.6.1/thinking-in-graphql">v1.6.1</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/docs/v1.6.0/thinking-in-graphql">v1.6.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v1.5.0/thinking-in-graphql">v1.5.0</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/v1.4.1/thinking-in-graphql">v1.4.1</a></li><li class="menu__list-item"><a class="menu__link" href="/versions">All versions</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/">Introduction to Relay</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/prerequisites">Prerequisites</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/installation-and-setup">Installation and Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/quick-start-guide">Quick Start Guide</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">API Reference</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/graphql-in-relay">GraphQL in Relay</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/relay-environment">Relay Environment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/network-layer">Network Layer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/query-renderer">QueryRenderer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/fragment-container">Fragment Container</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/refetch-container">Refetch Container</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/pagination-container">Pagination Container</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/mutations">Mutations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/subscriptions">Subscriptions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/relay-store">Relay Store</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/routing">Routing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/relay-debugging">Debugging</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/graphql-server-specification">GraphQL Server Specification</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Migration Guides</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/new-in-relay-modern">New in Relay Modern</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/relay-compat">Compatibility Mode</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/migration-setup">Migration Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/conversion-playbook">Conversion Playbook</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/conversion-scripts">Conversion Scripts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/upgrading-setvariables">Upgrading setVariables</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/converting-mutations">Converting Mutations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/compatibility-cheatsheet">Compatibility Cheatsheet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/v1.6.0/api-cheatsheet">API Cheatsheet</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Principles &amp; Architecture</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/v1.6.0/thinking-in-graphql">Thinking in GraphQL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.6.0/thinking-in-relay">Thinking In Relay</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.6.0/architecture-overview">Architecture Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.6.0/compiler-architecture">Compiler Architecture</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.6.0/runtime-architecture">Runtime Architecture</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/v1.6.0/videos">Videos</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for Relay <strong>v1.6.0</strong>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <strong><a href="/docs/">latest version</a></strong> (v11.0.0).</div></div><div class="docItemContainer_33ec"><article><div><span class="badge badge--secondary">Version: v1.6.0</span></div><header><h1 class="docTitle_3a4h">Thinking in GraphQL</h1></header><div class="markdown"><p>GraphQL presents new ways for clients to fetch data by focusing on the needs of product developers and client applications. It provides a way for developers to specify the precise data needed for a view and enables a client to fetch that data in a single network request. Compared to traditional approaches such as REST, GraphQL helps applications to fetch data more efficiently (compared to resource-oriented REST approaches) and avoid duplication of server logic (which can occur with custom endpoints). Furthermore, GraphQL helps developers to decouple product code and server logic. For example, a product can fetch more or less information without requiring a change to every relevant server endpoint. It&#x27;s a great way to fetch data.</p><p>In this article we&#x27;ll explore what it means to build a GraphQL client framework and how this compares to clients for more traditional REST systems. Along the way we&#x27;ll look at the design decisions behind Relay and see that it&#x27;s not just a GraphQL client but also a framework for <em>declarative data-fetching</em>. Let&#x27;s start at the beginning and fetch some data!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="fetching-data"></a>Fetching Data<a class="hash-link" href="#fetching-data" title="Direct link to heading">#</a></h2><p>Imagine we have a simple application that fetches a list of stories, and some details about each one. Here&#x27;s how that might look in resource-oriented REST:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><div tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Fetch the list of story IDs but not their details:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rest</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;/stories&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">then</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">stories</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// This resolves to a list of items with linked resources:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// `[ { href: &quot;http://.../story/1&quot; }, ... ]`</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token known-class-name class-name" style="color:rgb(255, 203, 107)">Promise</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">all</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">stories</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">map</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">story</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    rest</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">story</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token property-access">href</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Follow the links</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">then</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token parameter">stories</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// This resolves to a list of story items:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// `[ { id: &quot;...&quot;, text: &quot;...&quot; } ]`</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token console class-name" style="color:rgb(255, 203, 107)">console</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">stories</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Note that this approach requires <em>n+1</em> requests to the server: 1 to fetch the list, and <em>n</em> to fetch each item. With GraphQL we can fetch the same data in a single network request to the server (without creating a custom endpoint that we&#x27;d then have to maintain):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><div tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">graphql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token template-string string" style="color:rgb(195, 232, 141)">query { stories { id, text } }</span><span class="token template-string template-punctuation string" style="color:rgb(195, 232, 141)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">then</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token parameter">stories</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// A list of story items:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// `[ { id: &quot;...&quot;, text: &quot;...&quot; } ]`</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token console class-name" style="color:rgb(255, 203, 107)">console</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">stories</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>So far we&#x27;re just using GraphQL as a more efficient version of typical REST approaches. Note two important benefits in the GraphQL version:</p><ul><li>All data is fetched in a single round trip.</li><li>The client and server are decoupled: the client specifies the data needed instead of <em>relying on</em> the server endpoint to return the correct data.</li></ul><p>For a simple application that&#x27;s already a nice improvement.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="client-caching"></a>Client Caching<a class="hash-link" href="#client-caching" title="Direct link to heading">#</a></h2><p>Repeatedly refetching information from the server can get quite slow. For example, navigating from the list of stories, to a list item, and back to the list of stories means we have to refetch the whole list. We&#x27;ll solve this with the standard solution: <em>caching</em>.</p><p>In a resource-oriented REST system, we can maintain a <strong>response cache</strong> based on URIs:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><div tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> _cache </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Map</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">rest</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method-variable function-variable method function property-access" style="color:rgb(130, 170, 255)">get</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token parameter">uri</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">_cache</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">has</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _cache</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">fetch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword control-flow" style="font-style:italic">return</span><span class="token plain"> _cache</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">uri</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Response-caching can also be applied to GraphQL. A basic approach would work similarly to the REST version. The text of the query itself can be used as a cache key:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><div tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> _cache </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Map</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">graphql</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method-variable function-variable method function property-access" style="color:rgb(130, 170, 255)">get</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token parameter">queryText</span><span class="token plain"> </span><span class="token arrow operator" style="color:rgb(137, 221, 255)">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword control-flow" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">_cache</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">has</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">queryText</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _cache</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">queryText</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">fetchGraphQL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">queryText</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword control-flow" style="font-style:italic">return</span><span class="token plain"> _cache</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token method function property-access" style="color:rgb(130, 170, 255)">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">queryText</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Now, requests for previously cached data can be answered immediately without making a network request. This is a practical approach to improving the perceived performance of an application. However, this method of caching can cause problems with data consistency.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cache-consistency"></a>Cache Consistency<a class="hash-link" href="#cache-consistency" title="Direct link to heading">#</a></h2><p>With GraphQL it is very common for the results of multiple queries to overlap. However, our response cache from the previous section doesn&#x27;t account for this overlap â€” it caches based on distinct queries. For example, if we issue a query to fetch stories:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">query { stories { id, text, likeCount } }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>and then later refetch one of the stories whose <code>likeCount</code> has since been incremented:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">query { story(id: &quot;123&quot;) { id, text, likeCount } }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>We&#x27;ll now see different <code>likeCount</code>s depending on how the story is accessed. A view that uses the first query will see an outdated count, while a view using the second query will see the updated count.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="caching-a-graph"></a>Caching A Graph<a class="hash-link" href="#caching-a-graph" title="Direct link to heading">#</a></h3><p>The solution to caching GraphQL is to normalize the hierarchical response into a flat collection of <strong>records</strong>. Relay implements this cache as a map from IDs to records. Each record is a map from field names to field values. Records may also link to other records (allowing it to describe a cyclic graph), and these links are stored as a special value type that references back into the top-level map. With this approach each server record is stored <em>once</em> regardless of how it is fetched.</p><p>Here&#x27;s an example query that fetches a story&#x27;s text and its author&#x27;s name:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">query {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  story(id: &quot;1&quot;) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    author {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>And here&#x27;s a possible response:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">query: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  story: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     text: &quot;Relay is open-source!&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     author: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       name: &quot;Jan&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Although the response is hierarchical, we&#x27;ll cache it by flattening all the records. Here is an example of how Relay would cache this query response:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><div tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token known-class-name class-name" style="color:rgb(255, 203, 107)">Map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// `story(id: &quot;1&quot;)`</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(255, 203, 107)">Map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    text</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Relay is open-source!&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    author</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(130, 170, 255)">Link</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// `story.author`</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token known-class-name class-name" style="color:rgb(255, 203, 107)">Map</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Jan&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>This is only a simple example: in reality the cache must handle one-to-many associations and pagination (among other things).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="using-the-cache"></a>Using The Cache<a class="hash-link" href="#using-the-cache" title="Direct link to heading">#</a></h3><p>So how do we use this cache? Let&#x27;s look at two operations: writing to the cache when a response is received, and reading from the cache to determine if a query can be fulfilled locally (the equivalent to <code>_cache.has(key)</code> above, but for a graph).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="populating-the-cache"></a>Populating The Cache<a class="hash-link" href="#populating-the-cache" title="Direct link to heading">#</a></h3><p>Populating the cache involves walking a hierarchical GraphQL response and creating or updating normalized cache records. At first it may seem that the response alone is sufficient to process the response, but in fact this is only true for very simple queries. Consider <code>user(id: &quot;456&quot;) { photo(size: 32) { uri } }</code> â€” how should we store <code>photo</code>? Using <code>photo</code> as the field name in the cache won&#x27;t work because a different query might fetch the same field but with different argument values (e.g. <code>photo(size: 64) {...}</code>). A similar issue occurs with pagination. If we fetch the 11th to 20th stories with <code>stories(first: 10, offset: 10)</code>, these new results should be <em>appended</em> to the existing list.</p><p>Therefore, a normalized response cache for GraphQL requires processing payloads and queries in parallel. For example, the <code>photo</code> field from above might be cached with a generated field name such as <code>photo_size(32)</code> in order to uniquely identify the field and its argument values.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="reading-from-cache"></a>Reading From Cache<a class="hash-link" href="#reading-from-cache" title="Direct link to heading">#</a></h3><p>To read from the cache we can walk a query and resolve each field. But wait: that sounds <em>exactly</em> like what a GraphQL server does when it processes a query. And it is! Reading from the cache is a special case of an executor where a) there&#x27;s no need for user-defined field functions because all results come from a fixed data structure and b) results are always synchronous â€” we either have the data cached or we don&#x27;t.</p><p>Relay implements several variations of <strong>query traversal</strong>: operations that walk a query alongside some other data such as the cache or a response payload. For example, when a query is fetched Relay performs a &quot;diff&quot; traversal to determine what fields are missing (much like React diffs virtual DOM trees). This can reduce the amount of data fetched in many common cases and even allow Relay to avoid network requests at all when queries are fully cached.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cache-updates"></a>Cache Updates<a class="hash-link" href="#cache-updates" title="Direct link to heading">#</a></h3><p>Note that this normalized cache structure allows overlapping results to be cached without duplication. Each record is stored once regardless of how it is fetched. Let&#x27;s return to the earlier example of inconsistent data and see how this cache helps in that scenario.</p><p>The first query was for a list of stories:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">query { stories { id, text, likeCount } }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>With a normalized response cache, a record would be created for each story in the list. The <code>stories</code> field would store links to each of these records.</p><p>The second query refetched the information for one of those stories:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">query { story(id: &quot;123&quot;) { id, text, likeCount } }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>When this response is normalized, Relay can detect that this result overlaps with existing data based on its <code>id</code>. Rather than create a new record, Relay will update the existing <code>123</code> record. The new <code>likeCount</code> is therefore available to <em>both</em> queries, as well as any other query that might reference this story.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="dataview-consistency"></a>Data/View Consistency<a class="hash-link" href="#dataview-consistency" title="Direct link to heading">#</a></h2><p>A normalized cache ensures that the <em>cache</em> is consistent. But what about our views? Ideally, our React views would always reflect the current information from the cache.</p><p>Consider rendering the text and comments of a story along with the corresponding author names and photos. Here&#x27;s the GraphQL query:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">query {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  node(id: &quot;1&quot;) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    author { name, photo },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    comments {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      author { name, photo }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>After initially fetching this story our cache might be as follows. Note that the story and comment both link to the same record as <code>author</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Note: This is pseudo-code for `Map` initialization to make the structure</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// more obvious.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Map {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // `story(id: &quot;1&quot;)`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  1: Map {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    text: &#x27;got GraphQL?&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    author: Link(2),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    comments: [Link(3)],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // `story.author`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  2: Map {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: &#x27;Yuzhi&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    photo: &#x27;http://.../photo1.jpg&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // `story.comments[0]`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  3: Map {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    text: &#x27;Here\&#x27;s how to get one!&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    author: Link(2),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The author of this story also commented on it â€” quite common. Now imagine that some other view fetches new information about the author, and her profile photo has changed to a new URI. Here&#x27;s the <em>only</em> part of our cached data that changes:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Map {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  2: Map {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    photo: &#x27;http://.../photo2.jpg&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The value of the <code>photo</code> field has changed; and therefore the record <code>2</code> has also changed. And that&#x27;s it. Nothing else in the <em>cache</em> is affected. But clearly our <em>view</em> needs to reflect the update: both instances of the author in the UI (as story author and comment author) need to show the new photo.</p><p>A standard response is to &quot;just use immutable data structures&quot; â€” but let&#x27;s see what would happen if we did:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ImmutableMap {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  1: ImmutableMap // same as before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  2: ImmutableMap {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ... // other fields unchanged</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    photo: &#x27;http://.../photo2.jpg&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  3: ImmutableMap // same as before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>If we replace <code>2</code> with a new immutable record, we&#x27;ll also get a new immutable instance of the cache object. However, records <code>1</code> and <code>3</code> are untouched. Because the data is normalized, we can&#x27;t tell that <code>story</code>&#x27;s contents have changed just by looking at the <code>story</code> record alone.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="achieving-view-consistency"></a>Achieving View Consistency<a class="hash-link" href="#achieving-view-consistency" title="Direct link to heading">#</a></h3><p>There are a variety of solutions for keeping views up to date with a flattened cache. The approach that Relay takes is to maintain a mapping from each UI view to the set of IDs it references. In this case, the story view would subscribe to updates on the story (<code>1</code>), the author (<code>2</code>), and the comments (<code>3</code> and any others). When writing data into the cache, Relay tracks which IDs are affected and notifies <em>only</em> the views that are subscribed to those IDs. The affected views re-render, and unaffected views opt-out of re-rendering for better performance (Relay provides a safe but effective default <code>shouldComponentUpdate</code>). Without this strategy, every view would re-render for even the tiniest change.</p><p>Note that this solution will also work for <em>writes</em>: any update to the cache will notify the affected views, and writes are just another thing that updates the cache.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="mutations"></a>Mutations<a class="hash-link" href="#mutations" title="Direct link to heading">#</a></h2><p>So far we&#x27;ve looked at the process of querying data and keeping views up to date, but we haven&#x27;t looked at writes. In GraphQL, writes are called <strong>mutations</strong>. We can think of them as queries with side effects. Here&#x27;s an example of calling a mutation that might mark a given story as being liked by the current user:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Give a human-readable name and define the types of the inputs,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// in this case the id of the story to mark as liked.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">mutation StoryLike($storyID: String) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   // Call the mutation field and trigger its side effects</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   storyLike(storyID: $storyID) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     // Define fields to re-fetch after the mutation completes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     likeCount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Notice that we&#x27;re querying for data that <em>may</em> have changed as a result of the mutation. An obvious question is: why can&#x27;t the server just tell us what changed? The answer is: it&#x27;s complicated. GraphQL abstracts over <em>any</em> data storage layer (or an aggregation of multiple sources), and works with any programming language. Furthermore, the goal of GraphQL is to provide data in a form that is useful to product developers building a view.</p><p>We&#x27;ve found that it&#x27;s common for the GraphQL schema to differ slightly or even substantially from the form in which data is stored on disk. Put simply: there isn&#x27;t always a 1:1 correspondence between data changes in your underlying <em>data storage</em> (disk) and data changes in your <em>product-visible schema</em> (GraphQL). The perfect example of this is privacy: returning a user-facing field such as <code>age</code> might require accessing numerous records in our data-storage layer to determine if the active user is even allowed to <em>see</em> that <code>age</code> (Are we friends? Is my age shared? Did I block you? etc.).</p><p>Given these real-world constraints, the approach in GraphQL is for clients to query for things that may change after a mutation. But what exactly do we put in that query? During the development of Relay we explored several ideas â€” let&#x27;s look at them briefly in order to understand why Relay uses the approach that it does:</p><ul><li><p>Option 1: Re-fetch everything that the app has ever queried. Even though only a small subset of this data will actually change, we&#x27;ll still have to wait for the server to execute the <em>entire</em> query, wait to download the results, and wait to process them again. This is very inefficient.</p></li><li><p>Option 2: Re-fetch only the queries required by actively rendered views. This is a slight improvement over option 1. However, cached data that <em>isn&#x27;t</em> currently being viewed won&#x27;t be updated. Unless this data is somehow marked as stale or evicted from the cache subsequent queries will read outdated information.</p></li><li><p>Option 3: Re-fetch a fixed list of fields that <em>may</em> change after the mutation. We&#x27;ll call this list a <strong>fat query</strong>. We found this to also be inefficient because typical applications only render a subset of the fat query, but this approach would require fetching all of those fields.</p></li><li><p>Option 4 (Relay): Re-fetch the intersection of what may change (the fat query) and the data in the cache. In addition to the cache of data Relay also remembers the queries used to fetch each item. These are called <strong>tracked queries</strong>. By intersecting the tracked and fat queries, Relay can query exactly the set of information the application needs to update and nothing more.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="data-fetching-apis"></a>Data-Fetching APIs<a class="hash-link" href="#data-fetching-apis" title="Direct link to heading">#</a></h2><p>So far we looked at the lower-level aspects of data-fetching and saw how various familiar concepts translate to GraphQL. Next, let&#x27;s step back and look at some higher-level concerns that product developers often face around data-fetching:</p><ul><li>Fetching all the data for a view hierarchy.</li><li>Managing asynchronous state transitions and coordinating concurrent requests.</li><li>Managing errors.</li><li>Retrying failed requests.</li><li>Updating the local cache after receiving query/mutation responses.</li><li>Queuing mutations to avoid race conditions.</li><li>Optimistically updating the UI while waiting for the server to respond to mutations.</li></ul><p>We&#x27;ve found that typical approaches to data-fetching â€” with imperative APIs â€” force developers to deal with too much of this non-essential complexity. For example, consider <em>optimistic UI updates</em>. This is a way of giving the user feedback while waiting for a server response. The logic of <em>what</em> to do can be quite clear: when the user clicks &quot;like&quot;, mark the story as being liked and send the request to the server. But the implementation is often much more complex. Imperative approaches require us to implement all of those steps: reach into the UI and toggle the button, initiate a network request, retry it if necessary, show an error if it fails (and untoggle the button), etc. The same goes for data-fetching: specifying <em>what</em> data we need often dictates <em>how</em> and <em>when</em> it is fetched. Next, we&#x27;ll explore our approach to solving these concerns with <strong>Relay</strong>.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/relay/tree/main/website/versioned_docs/version-v1.6.0/PrinciplesAndArchitecture-ThinkingInGraphQL.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-07-01T16:02:25.000Z" class="lastUpdatedDate_1WI_">7/1/2021</time> by <strong>Tianyu Yao</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/v1.6.0/api-cheatsheet"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« API Cheatsheet</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/v1.6.0/thinking-in-relay"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Thinking In Relay Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#fetching-data" class="table-of-contents__link">Fetching Data</a></li><li><a href="#client-caching" class="table-of-contents__link">Client Caching</a></li><li><a href="#cache-consistency" class="table-of-contents__link">Cache Consistency</a><ul><li><a href="#caching-a-graph" class="table-of-contents__link">Caching A Graph</a></li><li><a href="#using-the-cache" class="table-of-contents__link">Using The Cache</a></li><li><a href="#populating-the-cache" class="table-of-contents__link">Populating The Cache</a></li><li><a href="#reading-from-cache" class="table-of-contents__link">Reading From Cache</a></li><li><a href="#cache-updates" class="table-of-contents__link">Cache Updates</a></li></ul></li><li><a href="#dataview-consistency" class="table-of-contents__link">Data/View Consistency</a><ul><li><a href="#achieving-view-consistency" class="table-of-contents__link">Achieving View Consistency</a></li></ul></li><li><a href="#mutations" class="table-of-contents__link">Mutations</a></li><li><a href="#data-fetching-apis" class="table-of-contents__link">Data-Fetching APIs</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs">Introduction</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/users">User Showcase</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/data-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Data Policy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/relay.svg" alt="" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/relay.svg" alt="" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></div></div></div></footer></div>
<script src="/assets/js/runtime~main.ef7b7e61.js"></script>
<script src="/assets/js/main.a42acebb.js"></script>
</body>
</html>